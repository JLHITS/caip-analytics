  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-20">
      <header className="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm/50 print:hidden">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2 sm:gap-4">
            <img src={logo} alt="CAIP Logo" className="h-10 w-10 rounded-lg object-cover" />
            <div>
              <h1 className="text-xl font-bold text-slate-900 leading-tight">CAIP Analytics <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full align-middle ml-2">{APP_VERSION}</span></h1>
              <p className="text-[10px] sm:text-xs text-slate-500 font-medium hidden sm:block">Free data analytics to help you improve capacity and access in primary care</p>
            </div>
          </div>

          <div className="flex items-center gap-4">
            <button
              onClick={() => setShowProcessingInfo(true)}
              className="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-600 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:text-blue-600 transition-all shadow-sm"
            >
              <Info size={16} />
              <span className="hidden sm:inline">How it works</span>
            </button>
            <div className="h-8 w-px bg-slate-200 mx-2 hidden sm:block"></div>
            <div className="hidden lg:flex items-center gap-3 bg-white dark:bg-slate-700 px-4 py-2 rounded-full border border-slate-200 dark:border-slate-600 shadow-sm">
              <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Made in</span>
              <a href="https://www.rushcliffehealth.org" target="_blank" rel="noopener noreferrer">
                <img src={rushcliffeLogo} alt="Rushcliffe PCN" className="h-8 w-auto grayscale hover:grayscale-0 transition-all opacity-80 hover:opacity-100" />
              </a>
              <a href="https://www.nottinghamwestpcn.co.uk" target="_blank" rel="noopener noreferrer">
                <img src={nottsWestLogo} alt="Nottingham West PCN" className="h-8 w-auto grayscale hover:grayscale-0 transition-all opacity-80 hover:opacity-100" />
              </a>
            </div>

            {!processedData && (
              <button
                onClick={loadExampleData}
                disabled={isProcessing}
                className="flex items-center gap-2 px-3 py-1.5 text-blue-600 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-full transition-all text-sm font-medium"
              >
                {isProcessing ? <Loader2 size={14} className="animate-spin" /> : <PlayCircle size={14} />}
                See Example
              </button>
            )}

            {processedData && (
              <div className="flex items-center gap-4 text-sm">
                <div className="relative group">
                  <div className="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-lg text-slate-600 cursor-pointer">
                    <Calendar size={14} />
                    <select
                      value={selectedMonth}
                      onChange={(e) => setSelectedMonth(e.target.value)}
                      className="bg-transparent border-none outline-none cursor-pointer text-sm font-medium appearance-none pr-4"
                    >
                      {availableMonths.map(m => (
                        <option key={m} value={m}>{m === 'All' ? 'All Months' : m}</option>
                      ))}
                    </select>
                    <ChevronDown size={12} className="absolute right-3 pointer-events-none" />
                  </div>
                </div>

                <button
                  onClick={() => setShowResetConfirm(true)}
                  className="text-slate-500 hover:text-red-600 transition-colors text-xs font-medium"
                >
                  Reset
                </button>
              </div>
            )}
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 print:hidden">
        {!processedData && (
          <div className="max-w-2xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="text-center mb-10">
              <div className="flex justify-center mb-4">
                <div className="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600 shadow-sm">
                  <Activity size={32} />
                </div>
              </div>
              <h2 className="text-3xl font-bold text-slate-900 mb-2">Let's analyse your demand and capacity</h2>
              <p className="text-slate-500">Upload your TPP SystmOne extracts (no patient data required) and X-on Surgery Connect management reports to get started.</p>
            </div>

            <Card className="mb-6">
              <SectionHeader title="Practice Details" />
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Surgery Name</label>
                  <input
                    type="text"
                    className="w-full px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all"
                    placeholder="e.g. High Street Practice"
                    value={config.surgeryName}
                    onChange={e => setConfig({ ...config, surgeryName: e.target.value })}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Patient Population</label>
                  <input
                    type="number"
                    className="w-full px-4 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all"
                    value={config.population}
                    onChange={e => setConfig({ ...config, population: e.target.value })}
                  />
                </div>
              </div>
              <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="flex flex-col">
                  <div className="flex items-center gap-2">
                    <input type="checkbox" id="telephony" className="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" checked={config.useTelephony} onChange={e => setConfig({ ...config, useTelephony: e.target.checked })} />
                    <label htmlFor="telephony" className="text-sm text-slate-700 font-medium">Analyse Telephony Data</label>
                  </div>
                  {!config.useTelephony && <p className="text-xs text-amber-600 mt-1 ml-6">Dashboard will be incomplete without call data.</p>}
                </div>
                <div className="flex flex-col">
                  <div className="flex items-center gap-2">
                    <input type="checkbox" id="online" className="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" checked={config.useOnline} onChange={e => setConfig({ ...config, useOnline: e.target.checked })} />
                    <label htmlFor="online" className="text-sm text-slate-700 font-medium">Analyse Online Requests</label>
                  </div>
                  {!config.useOnline && <p className="text-xs text-amber-600 mt-1 ml-6">Digital capacity metrics will not be shown.</p>}
                </div>
              </div>
            </Card>

            <Card>
              <SectionHeader title="Data Uploads" subtitle="Ensure date ranges match across files." />

              <FileInput
                label="Appointment Extract (CSV) *"
                accept=".csv"
                file={files.appointments}
                onChange={(e) => setFiles({ ...files, appointments: e.target.files[0] })}
                onRemove={() => setFiles({ ...files, appointments: null })}
              />
              <FileInput
                label="DNA Extract (CSV) *"
                helpText="(Must tick staff name and slot type in SystmOne)"
                accept=".csv"
                file={files.dna}
                onChange={(e) => setFiles({ ...files, dna: e.target.files[0] })}
                onRemove={() => setFiles({ ...files, dna: null })}
              />
              <FileInput
                label="Unused Extract (CSV) *"
                helpText="(Must tick staff name and slot type in SystmOne)"
                accept=".csv"
                file={files.unused}
                onChange={(e) => setFiles({ ...files, unused: e.target.files[0] })}
                onRemove={() => setFiles({ ...files, unused: null })}
              />
              <FileInput
                label="Online Requests (CSV) - SystmConnect"
                helpText="Misc Reports -> SystmConnect Report (Remove Patient Name column)"
                accept=".csv"
                file={files.onlineRequests}
                onChange={(e) => setFiles({ ...files, onlineRequests: e.target.files[0] })}
                onRemove={() => setFiles({ ...files, onlineRequests: null })}
                badge="Accurx Coming Soon"
                disabled={!config.useOnline}
              />

              <FileInput
                label="Telephony Reports (PDF) *"
                helpText="(Simply upload your X-on Surgery Connect Monthly Management Reports - only summary data is used)"
                accept="application/pdf"
                file={files.telephony}
                isMulti={true}
                onChange={(e) => {
                  if (e.target.files && e.target.files.length > 0) {
                    setFiles(prev => ({ ...prev, telephony: [...prev.telephony, ...Array.from(e.target.files)] }));
                  }
                }}
                onRemove={(index) => {
                  setFiles(prev => ({ ...prev, telephony: prev.telephony.filter((_, i) => i !== index) }));
                }}
                disabled={!config.useTelephony}
              />

              {error && (
                <div className="mb-4 p-4 bg-red-50 text-red-700 rounded-xl flex items-start gap-3 text-sm border border-red-100">
                  <AlertCircle size={18} className="shrink-0 mt-0.5" />
                  <span className="font-medium">{error}</span>
                </div>
              )}

              <button
                onClick={() => processFiles()}
                disabled={isProcessing || !files.appointments}
                className={`w-full py-3 rounded-xl font-bold text-white shadow-lg shadow-blue-500/20 transition-all
                   ${isProcessing || !files.appointments ? 'bg-slate-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 hover:scale-[1.02] active:scale-[0.98]'}
                 `}
              >
                {isProcessing ? 'Analysing Data...' : 'Generate Dashboard'}
              </button>
            </Card>
          </div>
        )}

        {processedData && (
          <div className="animate-in fade-in duration-700" id="dashboard-content">
            <div className="hidden print:block mb-8 text-center">
              <h1 className="text-3xl font-bold text-slate-900">CAIP Analysis - {config.surgeryName || 'Surgery Report'}</h1>
              <p className="text-slate-500">Generated on {new Date().toLocaleDateString()}</p>
            </div>

            {aiReport && (
              <Card className="mb-8 bg-gradient-to-br from-indigo-50 to-white border-indigo-100 animate-in slide-in-from-top-4 duration-500 shadow-md">
                <div className="flex items-center gap-3 mb-4">
                  <div className="p-2 bg-indigo-100 rounded-lg text-indigo-600">
                    <Sparkles size={20} />
                  </div>
                  <h3 className="text-lg font-bold text-indigo-900">CAIP Analysis</h3>
                  <button onClick={() => setAiReport(null)} className="ml-auto text-slate-400 hover:text-slate-600 text-sm">Close</button>
                </div>
                <div className="prose prose-sm prose-indigo max-w-none">
                  <SimpleMarkdown text={aiReport} />
                </div>
              </Card>
            )}

            {aiError && (
              <div className="mb-8 p-4 bg-red-50 text-red-700 rounded-xl flex items-center gap-2 text-sm">
                <AlertCircle size={16} />
                {aiError}
              </div>
            )}

            {/* ACTION BUTTONS: Centered above tabs */}
            <div className="flex justify-center gap-4 mb-6" data-html2canvas-ignore="true">
              {/* 1. CAIP Analysis Button */}
              <button
                onClick={generateAIInsights}
                disabled={isAiLoading}
                className="group relative inline-flex items-center justify-center px-8 py-3 overflow-hidden rounded-full bg-slate-900 font-medium text-white shadow-2xl transition-all duration-300 hover:scale-105 hover:shadow-purple-500/50 disabled:opacity-70"
              >
                <span className="absolute inset-0 h-full w-full bg-gradient-to-br from-purple-600 via-indigo-600 to-purple-700 opacity-100 transition-all duration-300 group-hover:from-purple-500 group-hover:via-indigo-500 group-hover:to-purple-600"></span>
                <span className="absolute inset-0 -translate-x-full bg-gradient-to-r from-transparent via-white/20 to-transparent transition-transform duration-1000 group-hover:translate-x-full"></span>
                <span className="absolute inset-0 rounded-full border border-white/20"></span>
                <span className="relative flex items-center gap-2">
                  {isAiLoading ? <Loader2 size={18} className="animate-spin" /> : <Sparkles size={18} className="animate-pulse" />}
                  <span className="font-bold tracking-wide">
                    C<span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-pink-300 animate-pulse">AI</span>P Analysis
                  </span>
                </span>
              </button>

              {/* 2. Print Report Button */}
              <button
                onClick={handlePrint}
					className="hidden flex items-center gap-2 px-6 py-3 bg-white text-slate-600 border border-slate-200 rounded-full hover:bg-slate-50 hover:border-slate-300 hover:text-slate-800 transition-all shadow-sm hover:shadow-md disabled:opacity-70"
				>
                <Download size={18} />
                <span className="font-semibold">Print Report</span>
              </button>
            </div>

            <div className="flex justify-center mb-8" data-html2canvas-ignore="true">
              <div className="bg-white p-1 rounded-xl shadow-sm border border-slate-200 inline-flex">
                {[
                  { id: 'dashboard', label: 'Overview', icon: Activity },
                  { id: 'gp', label: 'GP Metrics', icon: Users },
                  ...(config.useOnline && onlineStats ? [{ id: 'online', label: 'Online', icon: Monitor }] : []), // Conditional Tab
                  ...(config.useTelephony ? [{ id: 'telephony', label: 'Telephony', icon: Phone }] : []), // Conditional Tab
                  { id: 'forecast', label: 'Forecast', icon: Calendar }
                ].map(tab => (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${activeTab === tab.id ? 'bg-slate-100 text-slate-900' : 'text-slate-500 hover:text-slate-700'}`}
                  >
                    <tab.icon size={16} />
                    {tab.label}
                  </button>
                ))}
              </div>
            </div>

            {/* --- VISIBLE CONTENT (Interactive) --- */}
            {activeTab === 'dashboard' && (
              <div className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <MetricCard
                    title="Total Appointments"
                    value={displayedData.reduce((a, b) => a + (b.totalAppts || 0), 0).toLocaleString()}
                    subtext={selectedMonth === 'All' ? `Over ${processedData.length} months` : selectedMonth}
                    icon={Calendar}
                    color="text-blue-600"
                  />
                  <MetricCard
                    title="Total Online Requests"
                    value={displayedData.reduce((a, b) => a + (b.onlineTotal || 0), 0).toLocaleString()}
                    subtext="All request types"
                    icon={Monitor}
                    color="text-teal-600"
                  />
                  <MetricCard
                    title="Avg Inbound Calls"
                    value={Math.round(displayedData.reduce((a, b) => a + (b.inboundReceived || 0), 0) / (selectedMonth === 'All' ? displayedData.length : 1)).toLocaleString()}
                    subtext="Per month"
                    icon={Phone}
                    color="text-indigo-600"
                  />
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <Card className="h-80 lg:col-span-1">
                    <h3 className="font-bold text-slate-700 mb-4">Appointment Trends</h3>
                    <Line data={createChartData('Total Appointments', 'totalAppts', NHS_BLUE)} options={commonOptions} />
                  </Card>
                  <Card className="h-80">
                    <h3 className="font-bold text-slate-700 mb-2">Online Request Rate</h3>
                    <p className="text-xs text-slate-400 mb-4">Requests per 1000 patients per week</p>
                    <Line data={createChartData('Requests/1000/wk', 'onlineRequestsPer1000', NHS_AQUA, false)} options={onlineRequestBandOptions} />
                  </Card>
                </div>

                <Accordion title="Staff Breakdown (All Staff)" icon={Users}>
                  {seasonalWarning}
                  {aggregatedStaffData && (
                    <SortableTable
                      data={aggregatedStaffData}
                      columns={[
                        { header: 'Name', accessor: 'name' },
                        { header: 'Appointments', accessor: 'appts', render: (row) => Math.round(row.appts).toLocaleString() },
                        { header: unusedHeader, accessor: 'unused', render: (row) => `${Math.round(row.unused).toLocaleString()} (${((row.unused / (row.appts + row.unused || 1)) * 100).toFixed(1)}%)` },
                        { header: dnaHeader, accessor: 'dna', render: (row) => `${Math.round(row.dna).toLocaleString()} (${((row.dna / (row.appts || 1)) * 100).toFixed(1)}%)` }
                      ]}
                    />
                  )}
                </Accordion>

                <Accordion title="Slot Type Breakdown (All Slots)" icon={Activity}>
                  {seasonalWarning}
                  {aggregatedSlotData && (
                    <SortableTable
                      data={aggregatedSlotData}
                      searchPlaceholder="Search slot type..."
                      columns={[
                        { header: 'Slot Type', accessor: 'name' },
                        { header: 'Appointments', accessor: 'appts', render: (row) => Math.round(row.appts).toLocaleString() },
                        { header: unusedHeader, accessor: 'unused', render: (row) => `${Math.round(row.unused).toLocaleString()} (${((row.unused / (row.appts + row.unused || 1)) * 100).toFixed(1)}%)` },
                        { header: dnaHeader, accessor: 'dna', render: (row) => `${Math.round(row.dna).toLocaleString()} (${((row.dna / (row.appts || 1)) * 100).toFixed(1)}%)` }
                      ]}
                    />
                  )}
                </Accordion>

                <Accordion title="Staff & Slot Performance" icon={User}>
                  {seasonalWarning}
                  {aggregatedCombinedData && (
                    <SortableTable
                      data={aggregatedCombinedData}
                      searchPlaceholder="Search staff or slot..."
                      columns={[
                        { header: 'Name', accessor: 'name' },
                        { header: 'Slot Type', accessor: 'slot', render: (row) => row.slot || '-' },
                        { header: 'Appointments', accessor: 'appts', render: (row) => Math.round(row.appts).toLocaleString() },
                        { header: unusedHeader, accessor: 'unused', render: (row) => `${Math.round(row.unused).toLocaleString()} (${((row.unused / (row.appts + row.unused || 1)) * 100).toFixed(1)}%)` },
                        { header: dnaHeader, accessor: 'dna', render: (row) => `${Math.round(row.dna).toLocaleString()} (${((row.dna / (row.appts || 1)) * 100).toFixed(1)}%)` }
                      ]}
                    />
                  )}
                </Accordion>
              </div>
            )}

            {activeTab === 'gp' && (
              <div className="space-y-6">
                <Card className="h-96 border-2 border-teal-100 shadow-md bg-gradient-to-br from-white to-teal-50/30">
                  <h3 className="font-bold text-slate-800 mb-2 text-lg flex items-center gap-2"><Activity className="text-teal-600" size={24} /> Patients with GP Appointment or Resolved Online Request per Day (%)</h3>
                  <p className="text-sm text-slate-500 mb-4">Percentage of registered patients each working day who either attended a GP appointment or had their online request resolved without needing one.</p>
                  <div className="h-72">
                    <Line data={createChartData('GP appointment or online resolve per day (%)', 'gpTriageCapacityPerDayPct', NHS_AQUA, false)} options={gpBandOptions} />
                  </div>
                </Card>

                <Card className="h-96 border-2 border-blue-100 shadow-md">
                  <h3 className="font-bold text-slate-800 mb-2 text-lg">Patients with GP Appointment per Day (%)</h3>
                  <p className="text-sm text-slate-500 mb-4">Performance Bands: Red (&lt;0.85%), Amber (0.85-1.10%), Green (1.10-1.30%), Blue (&gt;1.30%)</p>
                  <div className="h-72">
                    <Line data={createChartData('GP Appts %', 'gpApptsPerDay', NHS_DARK_BLUE, false)} options={gpBandOptions} />
                  </div>
                </Card>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <Card className="h-80">
                    <h3 className="font-bold text-slate-700 mb-2">GP Capacity Utilisation</h3>
                    <p className="text-xs text-slate-400 mb-4">% of total GP capacity (Appts + Unused) that was used</p>
                    <Line data={createChartData('Utilisation %', 'gpUtilization', NHS_GREEN)} options={utilizationOptions} />
                  </Card>
                  <Card className="h-80">
                    <h3 className="font-bold text-slate-700 mb-2">GP Booking Conversion</h3>
                    <p className="text-xs text-slate-400 mb-4">GP Appointments per answered call</p>
                    <Line data={createChartData('GP Conversion Ratio', 'gpConversionRatio', NHS_PURPLE)} options={ratioOptions} />
                  </Card>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <Card className="h-64">
                    <h3 className="font-bold text-slate-700 mb-2 text-sm uppercase">GP Unused Slots</h3>
                    <p className="text-xs text-slate-400 mb-4">% of total GP slots</p>
                    <div className="h-40">
                      <Line data={createChartData('GP Unused %', 'gpUnusedPct', NHS_GREEN)} options={percentageOptions} />
                    </div>
                  </Card>
                  <Card className="h-64">
                    <h3 className="font-bold text-slate-700 mb-2 text-sm uppercase">GP DNA Rate</h3>
                    <p className="text-xs text-slate-400 mb-4">% of GP appointments</p>
                    <div className="h-40">
                      <Line data={createChartData('GP DNA %', 'gpDNAPct', NHS_RED)} options={percentageOptions} />
                    </div>
                  </Card>
                  <Card className="h-64">
                    <h3 className="font-bold text-slate-700 mb-2 text-sm uppercase">GP Appointments</h3>
                    <div className="h-40">
                      <Bar data={{
                        labels: displayedData.map(d => d.month),
                        datasets: [
                          { label: 'GP Appointments', data: displayedData.map(d => d.gpAppts), backgroundColor: NHS_BLUE },
                        ]
                      }} options={commonOptions} />
                    </div>
                  </Card>
                </div>

                <Accordion title="GP Performance Breakdown" icon={User}>
                  {seasonalWarning}
                  {aggregatedStaffData && (
                    <SortableTable
                      data={aggregatedStaffData.filter(s => s.isGP)}
                      columns={[
                        { header: 'GP Name', accessor: 'name' },
                        { header: 'Appointments', accessor: 'appts', render: (row) => Math.round(row.appts).toLocaleString() },
                        { header: unusedHeader, accessor: 'unused', render: (row) => `${Math.round(row.unused).toLocaleString()} (${((row.unused / (row.appts + row.unused || 1)) * 100).toFixed(1)}%)` },
                        { header: dnaHeader, accessor: 'dna', render: (row) => `${Math.round(row.dna).toLocaleString()} (${((row.dna / (row.appts || 1)) * 100).toFixed(1)}%)` }
                      ]}
                    />
                  )}
                </Accordion>

                <Accordion title="GP Slot Type Breakdown" icon={Activity}>
                  {seasonalWarning}
                  {aggregatedSlotData && (
                    <SortableTable
                      data={aggregatedSlotData.filter(s => s.hasGPActivity)}
                      searchPlaceholder="Search slot type..."
                      columns={[
                        { header: 'Slot Type', accessor: 'name' },
                        { header: 'Appointments', accessor: 'appts', render: (row) => Math.round(row.appts).toLocaleString() },
                        { header: unusedHeader, accessor: 'unused', render: (row) => `${Math.round(row.unused).toLocaleString()} (${((row.unused / (row.appts + row.unused || 1)) * 100).toFixed(1)}%)` },
                        { header: dnaHeader, accessor: 'dna', render: (row) => `${Math.round(row.dna).toLocaleString()} (${((row.dna / (row.appts || 1)) * 100).toFixed(1)}%)` }
                      ]}
                    />
                  )}
                </Accordion>

                <Accordion title="GP Staff & Slot Performance" icon={User}>
                  {seasonalWarning}
                  {aggregatedCombinedData && (
                    <SortableTable
                      data={aggregatedCombinedData.filter(s => s.isGP)}
                      searchPlaceholder="Search GP or slot..."
                      columns={[
                        { header: 'Name', accessor: 'name' },
                        { header: 'Slot Type', accessor: 'slot', render: (row) => row.slot || '-' },
                        { header: 'Appointments', accessor: 'appts', render: (row) => Math.round(row.appts).toLocaleString() },
                        { header: unusedHeader, accessor: 'unused', render: (row) => `${Math.round(row.unused).toLocaleString()} (${((row.unused / (row.appts + row.unused || 1)) * 100).toFixed(1)}%)` },
                        { header: dnaHeader, accessor: 'dna', render: (row) => `${Math.round(row.dna).toLocaleString()} (${((row.dna / (row.appts || 1)) * 100).toFixed(1)}%)` }
                      ]}
                    />
                  )}
                </Accordion>
              </div>
            )}

            {/* NEW ONLINE TAB */}
            {activeTab === 'online' && onlineStats && (
              <div className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                  <Card className="p-4 flex flex-col justify-between">
                    <p className="text-xs font-bold text-slate-400 uppercase">Offered/Booked Appt</p>
                    <h3 className="text-2xl font-bold text-blue-600">{onlineStats.totalOfferedOrBooked.toLocaleString()}</h3>
                  </Card>
                  <Card className="p-4 flex flex-col justify-between">
                    <p className="text-xs font-bold text-slate-400 uppercase">Digital Resolve</p>
                    <h3 className="text-2xl font-bold text-green-600">{onlineStats.totalResolved.toLocaleString()}</h3>
                  </Card>
                  <Card className="p-4 flex flex-col justify-between">
                    <p className="text-xs font-bold text-slate-400 uppercase">Avg Requests/Month</p>
                    <h3 className="text-2xl font-bold text-indigo-600">{Math.round(displayedData.reduce((a, b) => a + (b.onlineTotal || 0), 0) / (selectedMonth === 'All' ? displayedData.length : 1)).toLocaleString()}</h3>
                  </Card>
                  <Card className="p-4 flex flex-col justify-between">
                    <p className="text-xs font-bold text-slate-400 uppercase">Avg Patient Age</p>
                    <h3 className="text-2xl font-bold text-amber-600">{onlineStats.ageCount ? Math.round(onlineStats.totalAge / onlineStats.ageCount) : 0} yrs</h3>
                  </Card>
                  <Card className="p-4 flex flex-col justify-between">
                    <p className="text-xs font-bold text-slate-400 uppercase">Avg Time (Clin vs Admin)</p>
                    <div className="flex flex-col gap-1">
                      <div className="flex justify-between text-xs"><span>Clinical:</span> <span className="font-bold text-purple-600">{onlineStats.clinicalDurationCount ? (onlineStats.clinicalDurationTotal / onlineStats.clinicalDurationCount).toFixed(1) : 0}h</span></div>
                      <div className="flex justify-between text-xs"><span>Admin:</span> <span className="font-bold text-slate-600">{onlineStats.adminDurationCount ? (onlineStats.adminDurationTotal / onlineStats.adminDurationCount).toFixed(1) : 0}h</span></div>
                    </div>
                  </Card>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <Card className="h-64">
                    <h3 className="font-bold text-slate-700 mb-4">Request Type</h3>
                    <div className="h-48 relative">
                      <Doughnut data={createDonutData(onlineStats.typeBreakdown, [NHS_BLUE, NHS_AMBER])} options={donutOptions} />
                    </div>
                  </Card>
                  <Card className="h-64">
                    <h3 className="font-bold text-slate-700 mb-4">Access Method</h3>
                    <div className="h-48 relative">
                      <Doughnut data={createDonutData(onlineStats.accessMethod, [NHS_GREEN, NHS_PURPLE, NHS_AQUA])} options={donutOptions} />
                    </div>
                  </Card>
                  <Card className="h-64">
                    <h3 className="font-bold text-slate-700 mb-4">Patient Sex</h3>
                    <div className="h-48 relative">
                      <Doughnut data={createDonutData(onlineStats.sexSplit, [NHS_BLUE, NHS_PINK])} options={donutOptions} />
                    </div>
                  </Card>
                </div>

                <Card className="h-96">
                  <h3 className="font-bold text-slate-800 mb-4">Outcome Breakdown</h3>
                  <Bar
                    data={{
                      labels: Object.keys(onlineStats.outcomes),
                      datasets: [{
                        label: 'Count',
                        data: Object.values(onlineStats.outcomes),
                        backgroundColor: NHS_AQUA,
                        borderRadius: 4
                      }]
                    }}
                    options={{
                      ...commonOptions,
                      indexAxis: 'y', // Horizontal Bar Chart
                      scales: { x: { beginAtZero: true } }
                    }}
                  />
                </Card>
              </div>
            )}

            {activeTab === 'online' && !onlineStats && (
              <div className="text-center py-20 text-slate-400 bg-white rounded-xl border border-dashed border-slate-300">
                <Monitor size={48} className="mx-auto mb-4 opacity-50" />
                <p>No Online Request data uploaded.</p>
                <p className="text-sm mt-2">Upload a SystmConnect extract to see these metrics.</p>
              </div>
            )}

            {activeTab === 'telephony' && (
              <div className="space-y-6">
                {!config.useTelephony ? ( // Fixed condition logic
                  <div className="text-center py-20 text-slate-400">
                    <p>Telephony analysis is disabled.</p>
                  </div>
                ) : (
                  <>
                    <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                      {[
                        { l: 'Inbound Calls', k: 'inboundReceived', c: 'text-blue-600' },
                        { l: 'Answered Queue', k: 'answeredFromQueue', c: 'text-green-600', suffix: '%' },
                        { l: 'Abandoned', k: 'abandonedCalls', c: 'text-amber-600', suffix: '%' },
                        { l: 'Callbacks Success', k: 'callbacksSuccessful', c: 'text-blue-500' },
                        { l: 'Avg Wait', k: 'avgQueueTimeAnswered', c: 'text-slate-600', fmt: v => `${Math.floor(v / 60)}m ${v % 60}s` }
                      ].map((m, i) => (
                        <Card key={i} className="p-4 border border-slate-200 shadow-none bg-slate-50">
                          <p className="text-xs font-bold text-slate-400 uppercase">{m.l}</p>
                          <p className={`text-xl font-bold ${m.c} mt-1`}>
                            {m.fmt ? m.fmt(displayedData[displayedData.length - 1][m.k]) :
                              `${displayedData[displayedData.length - 1][m.k].toLocaleString()}${m.suffix || ''}`}
                          </p>
                          <p className="text-[10px] text-slate-400">{selectedMonth === 'All' ? 'Latest Month' : selectedMonth}</p>
                        </Card>
                      ))}
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                      <Card className="h-80">
                        <h3 className="font-bold text-slate-700 mb-4">Queue Percentage Split</h3>
                        <Bar data={{
                          labels: displayedData.map(d => d.month),
                          datasets: [
                            {
                              label: 'Answered %',
                              data: displayedData.map(d => 100 - (d.missedFromQueueExRepeatPct || 0)),
                              backgroundColor: NHS_GREEN
                            },
                            {
                              label: 'Missed (Unique) %',
                              data: displayedData.map(d => d.missedFromQueueExRepeatPct || 0),
                              backgroundColor: NHS_RED
                            }
                          ]
                        }} options={stackedPercentageOptions} />
                      </Card>
                      <Card className="h-80">
                        <h3 className="font-bold text-slate-700 mb-4">Abandoned Calls (%)</h3>
                        <Line data={createChartData('Abandoned %', 'abandonedCalls', NHS_AMBER)} options={percentageOptions} />
                      </Card>
                      <Card className="h-80">
                        <h3 className="font-bold text-slate-700 mb-4">Missed Call % (Unique)</h3>
                        <Line data={createChartData('Missed Unique %', 'missedFromQueueExRepeatPct', NHS_RED)} options={percentageOptions} />
                      </Card>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                      <Card className="h-64">
                        <h3 className="font-bold text-slate-700 mb-2 text-sm uppercase">Avg Queue Time (Answered)</h3>
                        <div className="h-40">
                          <Line data={createChartData('Time', 'avgQueueTimeAnswered', NHS_BLUE)} options={timeOptions} />
                        </div>
                      </Card>
                      <Card className="h-64">
                        <h3 className="font-bold text-slate-700 mb-2 text-sm uppercase">Avg Queue Time (Missed)</h3>
                        <div className="h-40">
                          <Line data={createChartData('Time', 'avgQueueTimeMissed', NHS_RED)} options={timeOptions} />
                        </div>
                      </Card>
                      <Card className="h-64">
                        <h3 className="font-bold text-slate-700 mb-2 text-sm uppercase">Avg Inbound Talk Time</h3>
                        <div className="h-40">
                          <Line data={createChartData('Time', 'avgInboundTalkTime', NHS_GREY)} options={timeOptions} />
                        </div>
                      </Card>
                    </div>
                  </>
                )}
              </div>
            )}

            {activeTab === 'forecast' && (
              <div className="max-w-4xl mx-auto space-y-6">
                <Card className="bg-gradient-to-br from-blue-600 to-indigo-700 text-white border-none">
                  <div className="flex items-start gap-4">
                    <div className="p-3 bg-white/10 rounded-xl">
                      <Activity size={32} />
                    </div>
                    <div>
                      <h3 className="text-2xl font-bold">Demand Forecasting (GP Only)</h3>
                      <p className="text-blue-100 mt-2 max-w-xl">
                        We've analyzed your missed calls, GP DNA rates, and GP unused slots to calculate the "Ideal" scenario.
                        This metric estimates the number of <strong>extra GP appointments per day</strong> required to meet hidden demand.
                      </p>
                    </div>
                  </div>
                </Card>

                <Card>
                  <h3 className="font-bold text-slate-800 mb-6">Extra GP Appointments Needed Per Day (Forecast)</h3>
                  <div className="h-80">
                    <Bar data={{
                      labels: displayedData.map(d => d.month),
                      datasets: [{
                        label: 'Shortfall (Slots/Day)',
                        data: displayedData.map(d => d.extraSlotsPerDay),
                        backgroundColor: displayedData.map(d => d.extraSlotsPerDay > 0 ? '#EF4444' : '#10B981'),
                      }]
                    }} options={pdfChartOptions} />
                  </div>
                  <div className="mt-6 bg-slate-50 p-4 rounded-xl text-sm text-slate-600">
                    <p className="font-semibold mb-2 flex items-center gap-2"><Info size={16} /> How is this calculated?</p>
                    <p className="mb-2">
                      We take the demand hidden in missed calls (extrapolated using your booking ratio) and subtract your wasted GP capacity (DNAs and Unused slots).
                    </p>
                    <code className="block bg-slate-100 p-2 rounded border border-slate-200 text-xs font-mono">
                      ( (GPAppts/AnsweredRatio ร MissedCalls) - (GPUnused + GPDNA) ) รท WorkingDays
                    </code>
                  </div>
                </Card>
                {forecastData && forecastData.hasData && (
                  <div>
                    <h3 className="text-xl font-bold text-slate-700 mb-4 mt-8">Future Trends (Next 2 Months)</h3>
                    <div className="grid grid-cols-2 gap-6">
                      <div className="h-80 border border-slate-200 rounded-xl p-4"><Line data={createForecastChartData('Actual Appointments', 'Forecast Trend', forecastData.appts, NHS_BLUE)} options={pdfChartOptions} /></div>
                      <div className="h-80 border border-slate-200 rounded-xl p-4"><Line data={createForecastChartData('Actual Calls', 'Forecast Trend', forecastData.calls, NHS_PURPLE)} options={pdfChartOptions} /></div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* --- HIDDEN PRINT CONTAINER --- */}
            <div id="pdf-report-container" className="hidden print:block bg-white w-full">

              <div id="pdf-title-page" className="flex flex-col items-center justify-center min-h-screen p-20 text-center bg-slate-50 break-after-page">
                <img src={logo} className="w-32 h-32 mb-8 rounded-xl shadow-lg" />
                <h1 className="text-6xl font-bold text-slate-900 mb-4">CAIP Analysis Report</h1>
                <h2 className="text-4xl text-blue-600 font-medium mb-12">{config.surgeryName || 'Surgery Report'}</h2>
                <p className="text-slate-500 text-xl">Generated on {new Date().toLocaleDateString()}</p>

                {aiReport && (
                  <div className="mt-12 text-left bg-white p-8 rounded-2xl shadow-sm border border-slate-200 max-w-4xl mx-auto">
                    <h3 className="text-2xl font-bold text-indigo-900 mb-4 flex items-center gap-2"><Sparkles className="text-indigo-500" /> CAIP Analysis Summary</h3>
                    <div className="prose prose-lg max-w-none text-slate-700">
                      <SimpleMarkdown text={aiReport} />
                    </div>
                  </div>
                )}
              </div>

              <div id="pdf-overview-section" className="p-10 space-y-8 break-after-page">
                <h2 className="text-3xl font-bold text-slate-800 border-b border-slate-200 pb-4 mb-6">1. Practice Overview</h2>
                <div className="grid grid-cols-3 gap-6">
                  <MetricCard title="Total Appointments" value={displayedData.reduce((a, b) => a + b.totalAppts, 0).toLocaleString()} icon={Calendar} color="text-blue-600" />
                  <MetricCard title="Avg Inbound Calls" value={Math.round(displayedData.reduce((a, b) => a + b.inboundReceived, 0) / (selectedMonth === 'All' ? displayedData.length : 1)).toLocaleString()} icon={Phone} color="text-indigo-600" />
                  <MetricCard title="Avg DNA Rate" value={`${(displayedData.reduce((a, b) => a + b.allDNAPct, 0) / (selectedMonth === 'All' ? displayedData.length : 1)).toFixed(2)}%`} icon={XCircle} color="text-red-500" />
                </div>
                <div className="h-96 border border-slate-200 rounded-xl p-4"><Line data={createChartData('Total Appointments', 'totalAppts', NHS_BLUE)} options={pdfChartOptions} /></div>

                <div className="mt-8">
                  <h3 className="text-xl font-bold text-slate-700 mb-4">Full Staff Breakdown</h3>
                  <SortableTable
                    data={aggregatedStaffData}
                    columns={[
                      { header: 'Name', accessor: 'name' },
                      { header: 'Appointments', accessor: 'appts', render: (row) => Math.round(row.appts).toLocaleString() },
                      { header: unusedHeader, accessor: 'unused', render: (row) => `${Math.round(row.unused).toLocaleString()} (${((row.unused / (row.appts + row.unused || 1)) * 100).toFixed(1)}%)` },
                      { header: dnaHeader, accessor: 'dna', render: (row) => `${Math.round(row.dna).toLocaleString()} (${((row.dna / (row.appts || 1)) * 100).toFixed(1)}%)` }
                    ]}
                    isPrint={true}
                  />
                </div>

                <div className="mt-8">
                  <h3 className="text-xl font-bold text-slate-700 mb-4">Slot Type Breakdown</h3>
                  <SortableTable
                    data={aggregatedSlotData}
                    columns={[
                      { header: 'Slot Type', accessor: 'name' },
                      { header: 'Appointments', accessor: 'appts', render: (row) => Math.round(row.appts).toLocaleString() },
                      { header: unusedHeader, accessor: 'unused', render: (row) => `${Math.round(row.unused).toLocaleString()} (${((row.unused / (row.appts + row.unused || 1)) * 100).toFixed(1)}%)` },
                      { header: dnaHeader, accessor: 'dna', render: (row) => `${Math.round(row.dna).toLocaleString()} (${((row.dna / (row.appts || 1)) * 100).toFixed(1)}%)` }
                    ]}
                    isPrint={true}
                  />
                </div>

                <div className="mt-8">
                  <h3 className="text-xl font-bold text-slate-700 mb-4">Staff & Slot Performance</h3>
                  <SortableTable
                    data={aggregatedCombinedData}
                    columns={[
                      { header: 'Name', accessor: 'name' },
                      { header: 'Slot Type', accessor: 'slot', render: (row) => row.slot || '-' },
                      { header: 'Appointments', accessor: 'appts', render: (row) => Math.round(row.appts).toLocaleString() },
                      { header: unusedHeader, accessor: 'unused', render: (row) => `${Math.round(row.unused).toLocaleString()} (${((row.unused / (row.appts + row.unused || 1)) * 100).toFixed(1)}%)` },
                      { header: dnaHeader, accessor: 'dna', render: (row) => `${Math.round(row.dna).toLocaleString()} (${((row.dna / (row.appts || 1)) * 100).toFixed(1)}%)` }
                    ]}
                    isPrint={true}
                  />
                </div>
              </div>

              <div id="pdf-gp-section" className="p-10 space-y-8 break-after-page">
                <h2 className="text-3xl font-bold text-slate-800 border-b border-slate-200 pb-4 mb-6">2. GP Metrics</h2>
                <div className="h-96 border border-slate-200 rounded-xl p-4"><h3 className="font-bold text-slate-800 mb-2 text-lg">Patients with GP Appointment or Resolved Online Request per Day (%)</h3><Line data={createChartData('GP appointment or online resolve per day (%)', 'gpTriageCapacityPerDayPct', NHS_AQUA, true)} options={pdfGpBandOptions} /></div>
                <div className="h-96 border border-slate-200 rounded-xl p-4 mt-6"><h3 className="font-bold text-slate-800 mb-2 text-lg">Patients with GP Appointment (%)</h3><Line data={createChartData('GP Appts %', 'gpApptsPerDay', NHS_DARK_BLUE, false)} options={pdfGpBandOptions} /></div>
                <div className="grid grid-cols-2 gap-6">
                  <div className="h-80 border border-slate-200 rounded-xl p-4"><Line data={createChartData('Utilisation %', 'gpUtilization', NHS_GREEN)} options={pdfUtilizationOptions} /></div>
                  <div className="h-80 border border-slate-200 rounded-xl p-4"><Line data={createChartData('GP Conversion Ratio', 'gpConversionRatio', NHS_PURPLE)} options={pdfRatioOptions} /></div>
                </div>
                <div className="grid grid-cols-3 gap-6 mt-6">
                  <div className="h-64 border border-slate-200 rounded-xl p-4"><h3 className="font-bold text-slate-700 mb-2 text-sm uppercase">GP Unused Slots</h3><div className="h-40"><Line data={createChartData('GP Unused %', 'gpUnusedPct', NHS_GREEN)} options={pdfPercentageOptions} /></div></div>
                  <div className="h-64 border border-slate-200 rounded-xl p-4"><h3 className="font-bold text-slate-700 mb-2 text-sm uppercase">GP DNA Rate</h3><div className="h-40"><Line data={createChartData('GP DNA %', 'gpDNAPct', NHS_RED)} options={pdfPercentageOptions} /></div></div>
                  <div className="h-64 border border-slate-200 rounded-xl p-4"><h3 className="font-bold text-slate-700 mb-2 text-sm uppercase">GP Appointments</h3><div className="h-40"><Bar data={{ labels: displayedData.map(d => d.month), datasets: [{ label: 'GP Appointments', data: displayedData.map(d => d.gpAppts), backgroundColor: NHS_BLUE }] }} options={pdfChartOptions} /></div></div>
                </div>

                <div className="mt-8">
                  <h3 className="text-xl font-bold text-slate-700 mb-4">GP Staff Performance</h3>
                  <SortableTable
                    data={aggregatedStaffData.filter(s => s.isGP)}
                    columns={[
                      { header: 'GP Name', accessor: 'name' },
                      { header: 'Appointments', accessor: 'appts', render: (row) => Math.round(row.appts).toLocaleString() },
                      { header: unusedHeader, accessor: 'unused', render: (row) => `${Math.round(row.unused).toLocaleString()} (${((row.unused / (row.appts + row.unused || 1)) * 100).toFixed(1)}%)` },
                      { header: dnaHeader, accessor: 'dna', render: (row) => `${Math.round(row.dna).toLocaleString()} (${((row.dna / (row.appts || 1)) * 100).toFixed(1)}%)` }
                    ]}
                    isPrint={true}
                  />
                </div>

                <div className="mt-8">
                  <h3 className="text-xl font-bold text-slate-700 mb-4">GP Slot Type Breakdown</h3>
                  <SortableTable
                    data={aggregatedSlotData.filter(s => s.hasGPActivity)}
                    columns={[
                      { header: 'Slot Type', accessor: 'name' },
                      { header: 'Appointments', accessor: 'appts', render: (row) => Math.round(row.appts).toLocaleString() },
                      { header: unusedHeader, accessor: 'unused', render: (row) => `${Math.round(row.unused).toLocaleString()} (${((row.unused / (row.appts + row.unused || 1)) * 100).toFixed(1)}%)` },
                      { header: dnaHeader, accessor: 'dna', render: (row) => `${Math.round(row.dna).toLocaleString()} (${((row.dna / (row.appts || 1)) * 100).toFixed(1)}%)` }
                    ]}
                    isPrint={true}
                  />
                </div>

                <div className="mt-8">
                  <h3 className="text-xl font-bold text-slate-700 mb-4">GP Staff & Slot Performance</h3>
                  <SortableTable
                    data={aggregatedCombinedData.filter(s => s.isGP)}
                    columns={[
                      { header: 'Name', accessor: 'name' },
                      { header: 'Slot Type', accessor: 'slot', render: (row) => row.slot || '-' },
                      { header: 'Appointments', accessor: 'appts', render: (row) => Math.round(row.appts).toLocaleString() },
                      { header: unusedHeader, accessor: 'unused', render: (row) => `${Math.round(row.unused).toLocaleString()} (${((row.unused / (row.appts + row.unused || 1)) * 100).toFixed(1)}%)` },
                      { header: dnaHeader, accessor: 'dna', render: (row) => `${Math.round(row.dna).toLocaleString()} (${((row.dna / (row.appts || 1)) * 100).toFixed(1)}%)` }
                    ]}
                    isPrint={true}
                  />
                </div>
              </div>

              {config.useOnline && onlineStats && (
                <div id="pdf-online-section" className="p-10 space-y-8 break-after-page">
                  <h2 className="text-3xl font-bold text-slate-800 border-b border-slate-200 pb-4 mb-6">3. Online Requests Analysis</h2>
                  <div className="grid grid-cols-5 gap-4 mb-6">
                    <Card className="p-4 flex flex-col justify-between"><p className="text-xs font-bold text-slate-400 uppercase">Offered/Booked</p><h3 className="text-2xl font-bold text-blue-600">{onlineStats.totalOfferedOrBooked.toLocaleString()}</h3></Card>
                    <Card className="p-4 flex flex-col justify-between"><p className="text-xs font-bold text-slate-400 uppercase">Digital Resolve</p><h3 className="text-2xl font-bold text-green-600">{onlineStats.totalResolved.toLocaleString()}</h3></Card>
                    <Card className="p-4 flex flex-col justify-between"><p className="text-xs font-bold text-slate-400 uppercase">Avg Requests/Mo</p><h3 className="text-2xl font-bold text-indigo-600">{Math.round(displayedData.reduce((a, b) => a + (b.onlineTotal || 0), 0) / (selectedMonth === 'All' ? displayedData.length : 1)).toLocaleString()}</h3></Card>
                    <Card className="p-4 flex flex-col justify-between"><p className="text-xs font-bold text-slate-400 uppercase">Avg Patient Age</p><h3 className="text-2xl font-bold text-amber-600">{onlineStats.ageCount ? Math.round(onlineStats.totalAge / onlineStats.ageCount) : 0} yrs</h3></Card>
                    <Card className="p-4 flex flex-col justify-between"><p className="text-xs font-bold text-slate-400 uppercase">Avg Time (Clin vs Admin)</p>
                      <div className="flex flex-col gap-1">
                        <div className="flex justify-between text-xs"><span>Clinical:</span> <span className="font-bold text-purple-600">{onlineStats.clinicalDurationCount ? (onlineStats.clinicalDurationTotal / onlineStats.clinicalDurationCount).toFixed(1) : 0}h</span></div>
                        <div className="flex justify-between text-xs"><span>Admin:</span> <span className="font-bold text-slate-600">{onlineStats.adminDurationCount ? (onlineStats.adminDurationTotal / onlineStats.adminDurationCount).toFixed(1) : 0}h</span></div>
                      </div>
                    </Card>
                  </div>
                  <div className="grid grid-cols-3 gap-6 h-80">
                    <div className="border border-slate-200 rounded-xl p-4"><h3 className="font-bold text-slate-700 mb-2 text-center">Request Type</h3><Doughnut data={createDonutData(onlineStats.typeBreakdown, [NHS_BLUE, NHS_AMBER])} options={donutOptions} /></div>
                    <div className="border border-slate-200 rounded-xl p-4"><h3 className="font-bold text-slate-700 mb-2 text-center">Access Method</h3><Doughnut data={createDonutData(onlineStats.accessMethod, [NHS_GREEN, NHS_PURPLE, NHS_AQUA])} options={donutOptions} /></div>
                    <div className="border border-slate-200 rounded-xl p-4"><h3 className="font-bold text-slate-700 mb-2 text-center">Patient Sex</h3><Doughnut data={createDonutData(onlineStats.sexSplit, [NHS_BLUE, NHS_PINK])} options={donutOptions} /></div>
                  </div>
                  <div className="h-96 border border-slate-200 rounded-xl p-4 mt-8">
                    <h3 className="font-bold text-slate-800 mb-4">Outcome Breakdown</h3>
                    <Bar data={{ labels: Object.keys(onlineStats.outcomes), datasets: [{ label: 'Count', data: Object.values(onlineStats.outcomes), backgroundColor: NHS_AQUA, borderRadius: 4 }] }} options={{ ...pdfChartOptions, indexAxis: 'y', scales: { x: { beginAtZero: true } } }} />
                  </div>
                </div>
              )}

              {config.useTelephony && (
                <div id="pdf-telephony-section" className="p-10 space-y-8 break-after-page">
                  <h2 className="text-3xl font-bold text-slate-800 border-b border-slate-200 pb-4 mb-6">4. Telephony Performance</h2>
                  <div className="grid grid-cols-5 gap-4 mb-6">
                    {[
                      { l: 'Inbound Calls', k: 'inboundReceived', c: 'text-blue-600' },
                      { l: 'Answered Queue', k: 'answeredFromQueue', c: 'text-green-600', suffix: '%' },
                      { l: 'Abandoned', k: 'abandonedCalls', c: 'text-amber-600', suffix: '%' },
                      { l: 'Callbacks Success', k: 'callbacksSuccessful', c: 'text-blue-500' },
                      { l: 'Avg Wait', k: 'avgQueueTimeAnswered', c: 'text-slate-600', fmt: v => `${Math.floor(v / 60)}m ${v % 60}s` }
                    ].map((m, i) => (
                      <Card key={i} className="p-4 border border-slate-200 shadow-none bg-slate-50">
                        <p className="text-xs font-bold text-slate-400 uppercase">{m.l}</p>
                        <p className={`text-xl font-bold ${m.c} mt-1`}>
                          {m.fmt ? m.fmt(displayedData[displayedData.length - 1][m.k]) :
                            `${displayedData[displayedData.length - 1][m.k].toLocaleString()}${m.suffix || ''}`}
                        </p>
                        <p className="text-[10px] text-slate-400">{selectedMonth === 'All' ? 'Latest Month' : selectedMonth}</p>
                      </Card>
                    ))}
                  </div>
                  <div className="grid grid-cols-3 gap-6 h-80">
                    <div className="border border-slate-200 rounded-xl p-4"><Bar data={{ labels: displayedData.map(d => d.month), datasets: [{ label: 'Answered %', data: displayedData.map(d => 100 - (d.missedFromQueueExRepeatPct || 0)), backgroundColor: NHS_GREEN }, { label: 'Missed %', data: displayedData.map(d => d.missedFromQueueExRepeatPct || 0), backgroundColor: NHS_RED }] }} options={pdfStackedPercentageOptions} /></div>
                    <div className="border border-slate-200 rounded-xl p-4"><Line data={createChartData('Abandoned %', 'abandonedCalls', NHS_AMBER)} options={pdfPercentageOptions} /></div>
                    <div className="border border-slate-200 rounded-xl p-4"><Line data={createChartData('Avg Queue Time', 'avgQueueTimeAnswered', NHS_BLUE)} options={pdfTimeOptions} /></div>
                  </div>
                  <div className="grid grid-cols-3 gap-6 h-80 mt-6">
                    <div className="border border-slate-200 rounded-xl p-4"><h3 className="font-bold text-slate-700 mb-2 text-sm">Missed (Unique) %</h3><Line data={createChartData('Missed Unique %', 'missedFromQueueExRepeatPct', NHS_RED)} options={pdfPercentageOptions} /></div>
                    <div className="border border-slate-200 rounded-xl p-4"><h3 className="font-bold text-slate-700 mb-2 text-sm">Avg Queue Time (Missed)</h3><Line data={createChartData('Time', 'avgQueueTimeMissed', NHS_RED)} options={pdfTimeOptions} /></div>
                    <div className="border border-slate-200 rounded-xl p-4"><h3 className="font-bold text-slate-700 mb-2 text-sm">Avg Inbound Talk Time</h3><Line data={createChartData('Time', 'avgInboundTalkTime', NHS_GREY)} options={pdfTimeOptions} /></div>
                  </div>
                </div>
              )}

              <div id="pdf-forecast-section" className="p-10 space-y-8 break-after-page">
                <h2 className="text-3xl font-bold text-slate-800 border-b border-slate-200 pb-4 mb-6">5. Demand Forecast (GP Only)</h2>
                <div className="bg-blue-50 p-6 rounded-xl border border-blue-100 text-blue-800 mb-6">
                  <p className="text-lg">This chart estimates the number of extra GP appointments per day required to meet hidden demand from missed calls.</p>
                </div>
                <div className="h-96 border border-slate-200 rounded-xl p-4">
                  <Bar data={{ labels: displayedData.map(d => d.month), datasets: [{ label: 'Shortfall (Slots/Day)', data: displayedData.map(d => d.extraSlotsPerDay), backgroundColor: displayedData.map(d => d.extraSlotsPerDay > 0 ? '#EF4444' : '#10B981') }] }} options={pdfChartOptions} />
                </div>
                {forecastData && forecastData.hasData && (
                  <div>
                    <h3 className="text-xl font-bold text-slate-700 mb-4 mt-8">Future Trends (Next 2 Months)</h3>
                    <div className="grid grid-cols-2 gap-6">
                      <div className="h-80 border border-slate-200 rounded-xl p-4"><Line data={createForecastChartData('Actual Appointments', 'Forecast Trend', forecastData.appts, NHS_BLUE)} options={pdfChartOptions} /></div>
                      <div className="h-80 border border-slate-200 rounded-xl p-4"><Line data={createForecastChartData('Actual Calls', 'Forecast Trend', forecastData.calls, NHS_PURPLE)} options={pdfChartOptions} /></div>
                    </div>
                  </div>
                )}
              </div>

            </div>

          </div>
        )}
      </main>

      <DataProcessingModal isOpen={showProcessingInfo} onClose={() => setShowProcessingInfo(false)} />

      <ResetConfirmationModal
        isOpen={showResetConfirm}
        onClose={() => setShowResetConfirm(false)}
        onConfirm={() => {
          setProcessedData(null);
          setSelectedMonth('All');
          setAiReport(null);
          setConfig({ ...config, surgeryName: '', population: 10000 });
          setFiles({ appointments: null, dna: null, unused: null, onlineRequests: null, telephony: [] });
          setRawStaffData([]);
          setRawSlotData([]);
          setRawCombinedData([]);
          setRawOnlineData([]);
          setForecastData(null);
          setShowResetConfirm(false);
        }}
      />
    </div>
  );
