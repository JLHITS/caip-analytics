/**
 * Data Loader for Pre-processed JSON Data
 *
 * This module provides functions to load pre-processed national data
 * that was converted from XLSX to JSON at build time.
 *
 * Benefits:
 * - JSON parsing is 10-20x faster than XLSX parsing
 * - No CPU-intensive parsing at runtime
 * - Smaller bundle size (JSON is more compact)
 */

// Import pre-processed JSON data
// These will be generated by scripts/preprocess-data.js at build time
let appointmentsData = null;
let telephonyData = null;
let onlineConsultationsData = null;

// Cache for loaded data
const dataCache = {
  appointments: null,
  telephony: null,
  onlineConsultations: null,
};

/**
 * Load appointments data from pre-processed JSON
 * @returns {Promise<Object>} Appointments data by month
 */
export async function loadAppointmentsData() {
  if (dataCache.appointments) {
    return dataCache.appointments;
  }

  try {
    const indexResponse = await fetch('/data/appointments-index.json');
    if (indexResponse.ok) {
      const indexData = await indexResponse.json();
      const months = Array.isArray(indexData.months) ? indexData.months : Object.keys(indexData.files || {});
      const fileMap = indexData.files || {};

      const entries = await Promise.all(months.map(async (month) => {
        const relativePath = fileMap[month] || `appointments/${month.replace(/\\s+/g, '_')}.json`;
        const response = await fetch(`/data/${relativePath}`);
        if (!response.ok) {
          throw new Error(`Failed to load appointments data for ${month}: ${response.status}`);
        }
        const data = await response.json();
        return [month, data];
      }));

      const data = Object.fromEntries(entries);
      data.metadata = { ...(indexData.metadata || {}), months, files: fileMap };
      dataCache.appointments = data;
      return data;
    }
  } catch (error) {
    console.error('Error loading appointments index:', error);
  }

  try {
    const response = await fetch('/data/appointments.json');
    if (!response.ok) {
      throw new Error(`Failed to load appointments data: ${response.status}`);
    }
    const data = await response.json();
    dataCache.appointments = data;
    return data;
  } catch (error) {
    console.error('Error loading appointments data:', error);
    throw error;
  }
}

/**
 * Load telephony data from pre-processed JSON
 * @returns {Promise<Object>} Telephony data by month
 */
export async function loadTelephonyData() {
  if (dataCache.telephony) {
    return dataCache.telephony;
  }

  try {
    const response = await fetch('/data/telephony.json');
    if (!response.ok) {
      throw new Error(`Failed to load telephony data: ${response.status}`);
    }
    const data = await response.json();
    dataCache.telephony = data;
    return data;
  } catch (error) {
    console.error('Error loading telephony data:', error);
    throw error;
  }
}

/**
 * Load online consultations data from pre-processed JSON
 * @returns {Promise<Object>} Online consultations data by month
 */
export async function loadOnlineConsultationsData() {
  if (dataCache.onlineConsultations) {
    return dataCache.onlineConsultations;
  }

  try {
    const response = await fetch('/data/online-consultations.json');
    if (!response.ok) {
      throw new Error(`Failed to load online consultations data: ${response.status}`);
    }
    const data = await response.json();
    dataCache.onlineConsultations = data;
    return data;
  } catch (error) {
    console.error('Error loading online consultations data:', error);
    throw error;
  }
}

/**
 * Load all data sources in parallel
 * @returns {Promise<Object>} All data sources
 */
export async function loadAllNationalData() {
  const [appointments, telephony, onlineConsultations] = await Promise.all([
    loadAppointmentsData(),
    loadTelephonyData(),
    loadOnlineConsultationsData(),
  ]);

  return {
    appointments,
    telephony,
    onlineConsultations,
  };
}

/**
 * Get data for a specific practice across all months
 * @param {string} odsCode - The practice ODS code
 * @param {string} dataType - 'appointments', 'telephony', or 'onlineConsultations'
 * @returns {Promise<Array>} Array of monthly data for the practice
 */
export async function getPracticeData(odsCode, dataType) {
  let data;

  switch (dataType) {
    case 'appointments':
      data = await loadAppointmentsData();
      break;
    case 'telephony':
      data = await loadTelephonyData();
      break;
    case 'onlineConsultations':
      data = await loadOnlineConsultationsData();
      break;
    default:
      throw new Error(`Unknown data type: ${dataType}`);
  }

  const practiceData = [];

  for (const [month, monthData] of Object.entries(data)) {
    if (month === 'metadata') continue;

    const practices = monthData.practices || monthData;
    const practice = practices.find(p => p.odsCode === odsCode || p.practiceCode === odsCode);

    if (practice) {
      practiceData.push({
        month,
        ...practice,
      });
    }
  }

  return practiceData;
}

/**
 * Search for practices by name or ODS code
 * @param {string} query - Search query
 * @param {string} dataType - Data source to search in
 * @returns {Promise<Array>} Matching practices
 */
export async function searchPractices(query, dataType = 'appointments') {
  let data;

  switch (dataType) {
    case 'appointments':
      data = await loadAppointmentsData();
      break;
    case 'telephony':
      data = await loadTelephonyData();
      break;
    case 'onlineConsultations':
      data = await loadOnlineConsultationsData();
      break;
    default:
      throw new Error(`Unknown data type: ${dataType}`);
  }

  const queryLower = query.toLowerCase();
  const practicesMap = new Map();

  // Get the latest month's data for searching
  const months = Object.keys(data).filter(k => k !== 'metadata');
  const latestMonth = months[months.length - 1];
  const monthData = data[latestMonth];
  const practices = monthData?.practices || monthData || [];

  for (const practice of practices) {
    const code = practice.odsCode || practice.practiceCode || '';
    const name = practice.practiceName || practice.name || '';

    if (code.toLowerCase().includes(queryLower) || name.toLowerCase().includes(queryLower)) {
      practicesMap.set(code, {
        odsCode: code,
        practiceName: name,
        icb: practice.icb || practice.icbName || '',
        pcn: practice.pcn || practice.pcnName || '',
      });
    }
  }

  return Array.from(practicesMap.values());
}

/**
 * Get available months for a data type
 * @param {string} dataType - 'appointments', 'telephony', or 'onlineConsultations'
 * @returns {Promise<Array>} Array of available months
 */
export async function getAvailableMonths(dataType) {
  let data;

  switch (dataType) {
    case 'appointments':
      data = await loadAppointmentsData();
      break;
    case 'telephony':
      data = await loadTelephonyData();
      break;
    case 'onlineConsultations':
      data = await loadOnlineConsultationsData();
      break;
    default:
      throw new Error(`Unknown data type: ${dataType}`);
  }

  return Object.keys(data).filter(k => k !== 'metadata');
}

/**
 * Clear the data cache (useful for testing or forced refresh)
 */
export function clearDataCache() {
  dataCache.appointments = null;
  dataCache.telephony = null;
  dataCache.onlineConsultations = null;
}

export default {
  loadAppointmentsData,
  loadTelephonyData,
  loadOnlineConsultationsData,
  loadAllNationalData,
  getPracticeData,
  searchPractices,
  getAvailableMonths,
  clearDataCache,
};
